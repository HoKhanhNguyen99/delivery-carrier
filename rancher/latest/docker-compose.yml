odoo:
  image: camptocamp/swisslux_odoo:latest
  command: odoo --load=web,web_kanban,session_redis,attachment_s3,logging_json
  external_links:
    - redis/redis:redis
  links:
    - db:db
  environment:
    - DB_USER=${DB_USER}
    - DB_PASSWORD=${DB_PASSWORD}
    - DB_NAME=${DB_NAME}
    - DB_PORT=${DB_PORT}
    - ADMIN_PASSWD=${ADMIN_PASSWD}
    - RUNNING_ENV=${RUNNING_ENV}
    - DEMO=${DEMO}
    - WORKERS=${WORKERS}
    - MAX_CRON_THREADS=${MAX_CRON_THREADS}
    - LOG_LEVEL=${LOG_LEVEL}
    - LOG_HANDLER=${LOG_HANDLER}
    - DB_MAXCONN=${DB_MAXCONN}
    - LIMIT_MEMORY_SOFT=${LIMIT_MEMORY_SOFT}
    - LIMIT_MEMORY_HARD=${LIMIT_MEMORY_HARD}
    - LIMIT_REQUEST=${LIMIT_REQUEST}
    - LIMIT_TIME_CPU=${LIMIT_TIME_CPU}
    - LIMIT_TIME_REAL=${LIMIT_TIME_REAL}
    - MARABUNTA_ALLOW_SERIE=True
    - MARABUNTA_MODE=${MARABUNTA_MODE}
    - ODOO_SESSION_REDIS=${ODOO_SESSION_REDIS}
    - ODOO_SESSION_REDIS_HOST=${ODOO_SESSION_REDIS_HOST}
    - ODOO_SESSION_REDIS_PREFIX=${ODOO_SESSION_REDIS_PREFIX}
    - ODOO_SESSION_REDIS_EXPIRATION=${ODOO_SESSION_REDIS_EXPIRATION}
    - ODOO_CLOUD_PLATFORM_UNSAFE=${ODOO_CLOUD_PLATFORM_UNSAFE}
    - ODOO_LOGGING_JSON=${ODOO_LOGGING_JSON}
    - ODOO_STATSD=${ODOO_STATSD}
    - STATSD_CUSTOMER=swisslux
    - STATSD_ENVIRONMENT=${STATSD_ENVIRONMENT}
    - STATSD_HOST=${STATSD_HOST}
    - STATSD_PORT=${STATSD_PORT}
  labels:
    io.rancher.scheduler.affinity:host_label: application=true

db:
  image: camptocamp/postgresql:pg9.5-latest
  environment:
    - POSTGRES_USER=${DB_USER}
    - POSTGRES_PASSWORD=${DB_PASSWORD}
  volumes:
    - swisslux-latest-datadb:/var/lib/postgresql
  labels:
    io.rancher.scheduler.affinity:host_label: application=true

nginx:
  image: camptocamp/odoo-nginx:9.0
  links:
    - odoo:odoo
  labels:
    io.rancher.scheduler.affinity:host_label: application=true
